#ajax异步上传

> 定义Form

```html
<form id="ff" enctype="multipart/form-data">
        <input type="text" name="name"><br>
        <input type="file" name="source"><img height="21px" id="sig"/><br>
        <input type="button" value="上传" onclick="upload();">
</form>
<img id="img"/>
```

> 定义ajax异步上传逻辑

```javascript
function upload(){
    //准备上传：显示进度条
    document.getElementById("sig").src="/static/app_ajax/load.gif";
    //创建xhr
    xhr = new XMLHttpRequest();
    xhr.open("post","/ajax/up_logic/");
    //设置监听：获取文件上传进度
    xhr.upload.onprogress=function(a){//文件上传过程中不断触发
        console.log(a.loaded);
        console.log(a.total);
        if(a.loaded == a.total)
            document.getElementById("sig").src="/static/app_ajax/ok.gif";
    };
    //设置监听：获取响应内容
    xhr.onreadystatechange=function(){
        if(xhr.readyState==4){
            ret = xhr.responseText //接受响应内容：图片在服务器的存储位置(访问路径)
            console.log(ret)
            //回显上传的图片
            document.getElementById("img").src="/static/"+ret;
        }
    }
    //FomrData(form的dom对象)
    xhr.send(new FormData(document.forms[0])) //发送请求，携带form的所有数据
}
```

> **定义Controller，接受上传的文件**
>
> `方式照旧`

> 补充：client可以可以通过jquery提供的方法$.ajax（）完成上传

```javascript
$.ajax({type:"post",
        data:new FormData(document.getElementById("ff")),
        url:"xxx",
        success:function(a){
              document.getElementById("img").src="/static/"+a
        },
        processData: false,#禁止编码请求参数
        contentType: false #不设置请求头
	   }
)
```

```javascript
$.ajax({xhr:function(){
              var xhr = $.ajaxSettings.xhr();//获取当前的xhr
              xhr.upload.onprogress=function(p){
                  if(p.loaded==p.total)
                      console.log("上传完成")
              }
              return xhr;
	    }
        type:"post",
        data:new FormData(document.getElementById("ff")),
        url:"xxx",
        success:function(a){
              document.getElementById("img").src="/static/"+a
        },
        processData: false,#禁止编码请求参数
        contentType: false #不设置请求头
       }
)

```

